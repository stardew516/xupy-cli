"use strict";var fs=require("fs"),path=require("path"),babel=require("babel-core"),stage1=require("babel-preset-stage-1"),es2015=require("babel-preset-es2015"),DOMParser=require("xmldom").DOMParser,uglifyjs=require("uglify-js"),less=require("less"),minCss=require("cssmin"),colors=require("colors"),sh=require("shelljs"),projectPath=process.cwd(),srcPath=path.resolve(projectPath,"src"),distPath=path.resolve(projectPath,"dist");function find_r(e,r){for(var t=2<arguments.length&&void 0!==arguments[2]?arguments[2]:"{",n=3<arguments.length&&void 0!==arguments[3]?arguments[3]:"}",s=[],i=r,c=e.length;i<c;i++){var o=e.charAt(i);if(t==o)s.push(i);else{if(n!=o)continue;if(s.pop(),!s.length)return i+1}}return r}function findstr(e,r){var t=e.indexOf(r),n=0;return-1===t?"":(n=find_r(e,t),e.substring(t,n))}module.exports={getScriptContent:function(e,n){var s="",r=(new DOMParser).parseFromString(e);return[].slice.call(r.childNodes||[]).forEach(function(e){var r=e.nodeName;if("script"===r&&e.hasAttribute("src")){var t=path.resolve(path.dirname(n),e.getAttribute("src"));s=fs.readFileSync(t,{encoding:"utf8"})}else"script"===r&&[].slice.call(e.childNodes||[]).forEach(function(e){s+=e.toString()})}),s},getWxml:function(e){var r="",t=(new DOMParser).parseFromString(e);return[].slice.call(t.childNodes||[]).forEach(function(e){"template"===e.nodeName&&[].slice.call(e.childNodes||[]).forEach(function(e){r+=e.toString()})}),r},getStyle:function(e,r){var n="",t=process.env.NODE_ENV,s=(new DOMParser).parseFromString(e);return[].slice.call(s.childNodes||[]).forEach(function(e){var r=e.nodeName;if("style"===r&&e.hasAttribute("src")){var t='@import "'+e.getAttribute("src").replace(".less",".wxss")+'";';n+=t}else"style"===r&&[].slice.call(e.childNodes||[]).forEach(function(e){n+=e.toString()})}),"production"===t&&(n=minCss(n)),n},getJsContent:function(e){var r="",t=process.env.NODE_ENV,n=e.substring(e.lastIndexOf("/")+1,e.lastIndexOf(".")),s=fs.readFileSync(e,{encoding:"utf8"}),i=this.babelJs(s,n);return r=i.code,"production"===t&&(r=this.upjs(i.code).code),r},compileStyle:function(e,r){var t="",n=process.env.NODE_ENV,s=fs.readFileSync(e,{encoding:"utf8"});switch(r){case"less":less.render(s,function(e,r){if(e)throw e;t=r.css.toString()})}return"production"===n&&(t=minCss(t)),t},babelJs:function(e,r){if(e)return babel.transform(e,{filename:r,presets:[es2015,stage1]})},getTypeUrl:function(e){var r=e.replace(path.resolve(process.cwd(),"src"),""),t={type:"app",path:"/"};return 0===r.indexOf("/pages")?t.type="page":0===r.indexOf("/components")?t.type="component":0===r.indexOf("/app.xu")&&(t.type="app"),t},getRelativePath:function(e){return e.replace(srcPath,"")},getConfig:function(e){process.env.NODE_ENV;var r=".config = ";return findstr(e,r).replace(r,"")},getModuleName:function(t,s){if("undefined"!==t)return new Promise(function(e,r){var n=t.match(/require(.*)xupy\/index['"]\)/gi)[0];e(t=t.replace(/exports\.default\s*=\s*(\w+);/gi,function(e,r){if("undefined"===r)return"";var t="";return"page"===s?t="\nPage("+n+".default.$createPage("+r+"));\n":"app"===s?t="\nApp("+n+".default.$createApp("+r+"));\n":"component"===s&&(t="\nComponent("+n+".default.$createComponent("+r+"));\n"),t}))})},writeFile:function(e,r){var t=path.resolve(process.cwd(),"dist"+e),n=t.split("/"),s="/"+n[n.length-1],i=t.replace(s,"");fs.existsSync(i)?fs.writeFileSync(t,r):this.mkdirsSync(i).then(function(e){fs.writeFileSync(t,r)})},mkdirsSync:function(t){var n=this;return new Promise(function(e,r){fs.existsSync(t)?e(!0):n.mkdirsSync(path.dirname(t))&&(fs.mkdirSync(t),e(!0))})},createDir:function(t){return new Promise(function(e,r){t=path.resolve(process.cwd(),"dist"+t),fs.existsSync(distPath)||fs.mkdirSync(t),e()})},upjs:function(e){return uglifyjs.minify(e)},trim:function(e){return e.replace(/\s+/g,"").replace(/[\r\n]/g,"")},log:function(e){var r=this.getTime();console.log(r.grey+e)},getTime:function(){var e=new Date;return"["+e.getHours()+":"+e.getMinutes()+":"+e.getSeconds()+"]"},delDir:function(e,r){var t=this,n=this.getRelativePath(e),s=path.resolve(process.cwd(),"dist"+n);if(r){var i="rm -rf "+s;sh.exec(i,function(){t.log(" [删除文件夹]".red+" dist"+n)})}else{var c=s.split("/"),o=c[c.length-1],a="rm "+s.replace(o,"")+(o.split(".")[0]+".*");sh.exec(a,function(){n.indexOf(".xu")?["json","js","wxml","wxss"].forEach(function(e){t.log(" [删除文件]".red+" dist"+n.replace(".xu","."+e))}):t.log(" [删除文件]".red+" dist"+n)})}},doCopy:function(){var t=this,n=path.join(__dirname,"../../xupy/dist"),s=path.join(projectPath,"./dist/xupy");fs.exists(s,function(e){if(!e){var r="cp -r "+n+" "+s;sh.exec(r,function(){t.log("拷贝依赖文件".green)})}})}};